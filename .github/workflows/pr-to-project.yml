name: Create Project Ticket on PR

on:
  pull_request:
    types: [opened, reopened]
  push:
    branches:
      - main
      - master

jobs:
  create-project-ticket:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
      project: write
    
    steps:
      - name: Get PR or Commit information
        id: pr_info
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const core = require('@actions/core');
            const isPR = context.eventName === 'pull_request';
            
            if (isPR) {
              const pr = context.payload.pull_request;
              core.setOutput('is_pr', 'true');
              core.setOutput('title', pr.title);
              core.setOutput('body', pr.body || pr.title);
              core.setOutput('number', String(pr.number));
              core.setOutput('author', pr.user.login);
              core.setOutput('url', pr.html_url);
              core.setOutput('branch', pr.head.ref);
              core.setOutput('node_id', pr.node_id);
            } else {
              // Push event
              const commit = context.payload.head_commit;
              const commits = context.payload.commits || [];
              const latestCommit = commits[commits.length - 1] || commit;
              
              core.setOutput('is_pr', 'false');
              core.setOutput('title', latestCommit?.message?.split('\n')[0] || 'Direct push to main');
              core.setOutput('body', latestCommit?.message || 'Direct push to main branch');
              core.setOutput('number', '');
              core.setOutput('author', latestCommit?.author?.username || context.actor);
              core.setOutput('url', latestCommit?.url || context.payload.repository.html_url);
              core.setOutput('branch', context.ref.replace('refs/heads/', ''));
              core.setOutput('node_id', '');
              core.setOutput('sha', context.sha);
            }

      - name: Get Project ID
        id: project
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // Get the repository owner and name
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            
            // Try to get Projects V2 (new GitHub Projects) first
            let projectId = null;
            let projectNumber = null;
            
            try {
              // List Projects V2 for the repository
              const projectsV2 = await github.graphql(`
                query($owner: String!, $repo: String!) {
                  repository(owner: $owner, name: $repo) {
                    projectsV2(first: 1) {
                      nodes {
                        id
                        number
                        title
                      }
                    }
                  }
                }
              `, {
                owner: owner,
                repo: repo
              });
              
              if (projectsV2.repository.projectsV2.nodes.length > 0) {
                projectId = projectsV2.repository.projectsV2.nodes[0].id;
                projectNumber = projectsV2.repository.projectsV2.nodes[0].number;
                console.log(`Found Project V2: ${projectsV2.repository.projectsV2.nodes[0].title} (ID: ${projectId})`);
              }
            } catch (error) {
              console.log('Could not access Projects V2, trying legacy Projects API');
            }
            
            // Fallback to legacy Projects API
            if (!projectId) {
              try {
                const projects = await github.rest.projects.listForRepo({
                  owner: owner,
                  repo: repo,
                });
                
                if (projects.data.length > 0) {
                  projectId = projects.data[0].id;
                  console.log(`Found legacy project: ${projects.data[0].name} (ID: ${projectId})`);
                } else {
                  // Try organization projects
                  try {
                    const orgProjects = await github.rest.projects.listForOrg({
                      org: owner,
                    });
                    if (orgProjects.data.length > 0) {
                      projectId = orgProjects.data[0].id;
                      console.log(`Found organization project: ${orgProjects.data[0].name} (ID: ${projectId})`);
                    }
                  } catch (error) {
                    console.log('No organization projects found or access denied');
                  }
                }
              } catch (error) {
                console.log('Could not access legacy Projects API:', error.message);
              }
            }
            
            if (!projectId) {
              console.log('âš ï¸ No projects found. Please create a GitHub Project first.');
              core.setOutput('id', '');
              core.setOutput('number', '');
            } else {
              core.setOutput('id', String(projectId));
              core.setOutput('number', String(projectNumber || ''));
            }

      - name: Create Project Item from PR or Push
        if: steps.project.outputs.id != ''
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const core = require('@actions/core');
            const isPR = context.eventName === 'pull_request';
            const projectId = '${{ steps.project.outputs.id }}';
            const projectNumber = '${{ steps.project.outputs.number }}';
            const title = '${{ steps.pr_info.outputs.title }}';
            const body = '${{ steps.pr_info.outputs.body }}';
            const author = '${{ steps.pr_info.outputs.author }}';
            const branch = '${{ steps.pr_info.outputs.branch }}';
            const url = '${{ steps.pr_info.outputs.url }}';
            const prNumber = '${{ steps.pr_info.outputs.number }}';
            const nodeId = '${{ steps.pr_info.outputs.node_id }}';
            const sha = '${{ steps.pr_info.outputs.sha }}';
            
            if (!projectId) {
              console.log('Skipping: No project ID found');
              return;
            }
            
            console.log(`Using project ID: ${projectId}`);
            console.log(`Event type: ${isPR ? 'Pull Request' : 'Push'}`);
            
            // Try to add PR directly to Project V2 first (only for PRs)
            let addedDirectly = false;
            if (isPR && projectNumber && nodeId) {
              try {
                const result = await github.graphql(`
                  mutation($projectId: ID!, $contentId: ID!) {
                    addProjectV2ItemById(input: {
                      projectId: $projectId
                      contentId: $contentId
                    }) {
                      item {
                        id
                      }
                    }
                  }
                `, {
                  projectId: projectId,
                  contentId: nodeId
                });
                
                console.log(`âœ… Added PR #${prNumber} directly to Project V2`);
                addedDirectly = true;
                
                // Comment on PR
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: parseInt(prNumber),
                  body: `ðŸ“‹ **Project Ticket Created**\n\nThis PR has been automatically added to the project board.`
                });
              } catch (error) {
                console.log('Could not add PR directly to Project V2:', error.message);
              }
            }
            
            // Fallback: Create issue and add to project (for both PRs and pushes)
            if (!addedDirectly) {
              try {
                const issueTitle = isPR 
                  ? `[Frontend PR #${prNumber}] ${title}`
                  : `[Frontend Push] ${title}`;
                
                const issueBody = isPR
                  ? `**Pull Request:** #${prNumber}\n\n**Repository:** Frontend (React)\n\n**Author:** @${author}\n\n**Branch:** \`${branch}\`\n\n**Description:**\n${body}\n\n**Link:** ${url}\n\n---\n\n*This ticket was automatically created from Pull Request #${prNumber}*`
                  : `**Commit:** ${sha ? sha.substring(0, 7) : 'N/A'}\n\n**Repository:** Frontend (React)\n\n**Author:** @${author}\n\n**Branch:** \`${branch}\`\n\n**Description:**\n${body}\n\n**Link:** ${url}\n\n---\n\n*This ticket was automatically created from a direct push to ${branch}*`;
                
                const labels = isPR 
                  ? ['frontend', 'project-management', 'pull-request']
                  : ['frontend', 'project-management', 'direct-push'];
                
                // Create an issue
                const issue = await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: issueTitle,
                  body: issueBody,
                  labels: labels
                });
                
                // Try to add issue to Project V2
                if (projectNumber) {
                  try {
                    await github.graphql(`
                      mutation($projectId: ID!, $contentId: ID!) {
                        addProjectV2ItemById(input: {
                          projectId: $projectId
                          contentId: $contentId
                        }) {
                          item {
                            id
                          }
                        }
                      }
                    `, {
                      projectId: projectId,
                      contentId: issue.data.node_id
                    });
                    
                    console.log(`âœ… Created project item via issue #${issue.data.number}`);
                  } catch (error) {
                    console.log('Could not add issue to Project V2, trying legacy API');
                    // Fallback to legacy API
                    await github.rest.projects.createCard({
                      project_id: projectId,
                      content_id: issue.data.id,
                      content_type: 'Issue'
                    });
                    console.log(`âœ… Created project card via issue #${issue.data.number}`);
                  }
                } else {
                  // Legacy project
                  await github.rest.projects.createCard({
                    project_id: projectId,
                    content_id: issue.data.id,
                    content_type: 'Issue'
                  });
                  console.log(`âœ… Created project card via issue #${issue.data.number}`);
                }
                
                // Comment on PR if it's a PR
                if (isPR && prNumber) {
                  await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: parseInt(prNumber),
                    body: `ðŸ“‹ **Project Ticket Created**\n\nIssue #${issue.data.number} has been created and added to the project board.\n\nView issue: ${issue.data.html_url}`
                  });
                }
              } catch (error) {
                console.log('Error creating project item:', error.message);
                throw error;
              }
            }

      - name: Summary
        if: always()
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "## PR to Project Integration Summary" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- **Repository:** Frontend (React)" >> $GITHUB_STEP_SUMMARY
            echo "- **PR Number:** #${{ github.event.pull_request.number }}" >> $GITHUB_STEP_SUMMARY
            echo "- **PR Title:** ${{ github.event.pull_request.title }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Author:** @${{ github.event.pull_request.user.login }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Branch:** \`${{ github.event.pull_request.head.ref }}\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "## Push to Project Integration Summary" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- **Repository:** Frontend (React)" >> $GITHUB_STEP_SUMMARY
            echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Commit Message:** ${{ steps.pr_info.outputs.title }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Author:** @${{ steps.pr_info.outputs.author }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Branch:** \`${{ steps.pr_info.outputs.branch }}\`" >> $GITHUB_STEP_SUMMARY
          fi
          echo "- **Project ID:** ${{ steps.project.outputs.id }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.project.outputs.id }}" != "" ]; then
            echo "âœ… Project ticket creation attempted" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            if [ "${{ github.event_name }}" == "pull_request" ]; then
              echo "The PR has been added to the project board." >> $GITHUB_STEP_SUMMARY
            else
              echo "The push has been added to the project board." >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âš ï¸ No project found. Please create a GitHub Project first." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "To set up:" >> $GITHUB_STEP_SUMMARY
            echo "1. Go to your repository" >> $GITHUB_STEP_SUMMARY
            echo "2. Click on the **Projects** tab" >> $GITHUB_STEP_SUMMARY
            echo "3. Create a new project" >> $GITHUB_STEP_SUMMARY
          fi

